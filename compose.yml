services:
  
  post-api-migrate:
    build:
      context: .
      dockerfile: Dockerfile
    command: npx prisma migrate deploy
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://postgres:1234@host.docker.internal:5432/post_test
    restart: "no"

  post-api:
    depends_on:
      - post-api-migrate
    build:
      context: .
      dockerfile: Dockerfile
    command: ["npm", "run", "start:prod" ]
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgresql://postgres:1234@host.docker.internal:5432/post_test
    ports:
      - "3000:3000"